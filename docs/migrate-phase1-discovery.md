# Phase 1 Discovery – Fiber to Echo & Official OpenAPI Generator Migration

## Scope
This document captures the Phase 1 discovery results outlined in `migrate-plan.md`, focusing on current Fiber-specific usage, middleware patterns, and the existing OpenAPI generation workflow. These findings will guide later Echo adoption and tooling changes.

## Fiber Integration Inventory
- `apps/server/main.go`: Bootstraps `fiber.New()`, attaches `slogfiber.New(logger)` middleware, and calls `route.SetupRoutes(app)` before listening on `config.AppPort`.
- `route/route.go`: Applies a global JWT/api-key `jwtMiddleware`, registers Fiber handlers generated from `packages/api` via `openapi.RegisterHandlers`, exposes additional auth routes, and serves embedded frontend assets with `fiber/middleware/filesystem`.
- `route/middleware.go`: Implements auth gating using Fiber `Ctx` primitives (`c.Path`, `c.Next`, `c.Locals`, `handler.SendError`). Distinguishes public, JWT-only, and API-key-only paths.
- `handler/response.go`: Centralizes error responses using `fiber.Map` and `c.Status(...).JSON(...)`.
- `handler/auth.go`: Handles OIDC login/redirect flows with Fiber contexts (`c.BaseURL`, `c.Query`, `c.Redirect`, `c.SendStatus`) and leverages shared model helpers.
- `internal/auth/oidc.go`: Depends on Fiber session middleware (`github.com/gofiber/fiber/v2/middleware/session`) to persist OAuth state, interacting with contexts via `sessionStore.Get(ctx)`.
- Generated server files (`packages/api/*.go`, notably `generated.go`, `auth.go`, `vault.go`, etc.) assume Fiber types (`*fiber.Ctx`, `fiber.Router`) and rely on helpers like `handler.SendError`.
- Fiber-specific dependencies include `github.com/gofiber/fiber/v2`, `github.com/gofiber/fiber/v2/middleware/filesystem`, `github.com/gofiber/fiber/v2/middleware/session`, and `github.com/samber/slog-fiber`.

## Middleware, Context, and Helpers
- Request context mutation uses `c.Locals` to stash authenticated `user`, `user_id`, or API key metadata for downstream handlers (`packages/api/vault.go`, `packages/api/cli_vault.go`).
- Authentication middleware raises structured errors via `handler.SendError`, which must be reimplemented for Echo.
- OIDC session storage relies on Fiber’s session store; porting will require an Echo-compatible replacement (e.g., echo-contrib/session) or a custom store.
- File serving uses Fiber’s filesystem middleware to expose embedded UI assets from `internal/embed`.

## OpenAPI Generation Workflow
- Specs live under `packages/api/openapi`, split into modular `paths/*` and `schemas/*` definitions referenced by `api.yaml`.
- `packages/api/tool.go` runs two `go:generate` steps:
  1. `bundle.sh` invokes `npx @redocly/cli bundle` to emit `api.bundled.yaml`.
  2. `go tool oapi-codegen -config cfg.yaml api.bundled.yaml` generates Go server code.
- `packages/api/cfg.yaml` requests `models`, `fiber-server`, and `strict-server`, causing generated types to target Fiber (`FiberServerOptions`, `fiber.Router`, `*fiber.Ctx`).
- Generated artifacts include `packages/api/generated.go` (router setup, strict handlers), plus hand-written partials (`auth.go`, `vault.go`, etc.) that implement `ServerInterface`.
- Downstream client generation relies on a separate module `github.com/lwshen/vault-hub-go-client`, likely published from the same spec via external tooling.

## Dependent Consumers & Touchpoints
- CLI (`apps/cli`, `internal/cli`) consumes the published Go client (`vault-hub-go-client`), which will need regeneration or replacement once official OpenAPI Generator output is introduced.
- Cron jobs currently show no direct Fiber usage but may depend on API models generated by `oapi-codegen`.
- Shared packages (`model`, `internal`) interact with handlers via Fiber contexts (e.g., retrieving `Locals`) and expect middleware to inject data.
- Docker/Air configurations implicitly assume Fiber entrypoints but will shift alongside the Echo bootstrap.

## Key Migration Considerations
- Identify Echo equivalents for current middleware: logging (replace `slogfiber`), static file serving, JWT & API-key auth, and session management.
- Rework error/response helpers to wrap Echo types while preserving consistent JSON payloads.
- Ensure context-local data (user, API key) continues to flow through Echo handlers.
- Plan for replacing `oapi-codegen` with the official OpenAPI Generator CLI, including bundling strategy (Redocly or alternative) and CI/scripts updates.
- Coordinate client regeneration (`vault-hub-go-client`) to prevent breaking CLI/SDK consumers when switching generation tooling.
