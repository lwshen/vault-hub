stages:
  - build

variables:
  BASE_IMAGE: shenlw/vault-hub-base:latest
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: "0"

build:
  stage: build
  image: ${BASE_IMAGE}
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go-cache/
      - .pnpm-store/
  before_script:
    - mkdir -p "$CI_PROJECT_DIR/.go-cache" "$CI_PROJECT_DIR/.pnpm-store"
    - export GOPATH="$CI_PROJECT_DIR/.go-cache"
    - export GOCACHE="$CI_PROJECT_DIR/.go-cache"
    - if command -v corepack >/dev/null 2>&1; then corepack enable; fi
    - pnpm config set store-dir "$CI_PROJECT_DIR/.pnpm-store"
    - go mod download
    - go mod verify
  script:
    - golangci-lint run ./...
    - pnpm --dir apps/web install
    - pnpm --dir apps/web build
    - |
      export JWT_SECRET=secret
      export ENCRYPTION_KEY=test-encryption-key-for-ci
      go test -v ./...
    - |
      VERSION="dev"
      COMMIT=$(git rev-parse --short HEAD)
      LDFLAGS="-X github.com/lwshen/vault-hub/internal/version.Version=${VERSION} -X github.com/lwshen/vault-hub/internal/version.Commit=${COMMIT}"

      mkdir -p bin

      # Linux builds
      GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-server-linux-amd64 apps/server/main.go
      GOOS=linux GOARCH=arm64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-server-linux-arm64 apps/server/main.go

      # Windows builds
      GOOS=windows GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-server-windows-amd64.exe apps/server/main.go

      # macOS builds
      GOOS=darwin GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-server-darwin-amd64 apps/server/main.go
      GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-server-darwin-arm64 apps/server/main.go
    - |
      VERSION="dev"
      COMMIT=$(git rev-parse --short HEAD)
      LDFLAGS="-X github.com/lwshen/vault-hub/internal/version.Version=${VERSION} -X github.com/lwshen/vault-hub/internal/version.Commit=${COMMIT}"

      mkdir -p bin

      # Linux builds
      GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-cli-linux-amd64 apps/cli/main.go
      GOOS=linux GOARCH=arm64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-cli-linux-arm64 apps/cli/main.go

      # Windows builds
      GOOS=windows GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-cli-windows-amd64.exe apps/cli/main.go

      # macOS builds
      GOOS=darwin GOARCH=amd64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-cli-darwin-amd64 apps/cli/main.go
      GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o bin/vault-hub-cli-darwin-arm64 apps/cli/main.go
build-openapi-typescript-client:
  stage: build
  image: ${BASE_IMAGE}
  script:
    # Set environment variables
    - export TAG=0.$(date +'%Y%m%d.%H%M%S')
    # Generate TypeScript Fetch client
    - openapi-generator generate -i packages/api/openapi/api.yaml -g typescript-fetch -o typescript-fetch-client --additional-properties=npmName=@lwshen/vault-hub-ts-fetch-client --additional-properties=npmVersion=${TAG} --additional-properties=useSingleRequestParameter=false --git-user-id lwshen --git-repo-id vault-hub
    # Build TypeScript Fetch client
    - cd typescript-fetch-client
    - echo $TAG
    - cat package.json
    - npm install
    - npm run build
build-openapi-go-client:
  stage: build
  image: ${BASE_IMAGE}
  script:
    # Set environment variables
    - export TAG=v0.$(date +'%Y%m%d.%H%M%S')
    # Generate Go client
    - openapi-generator generate -i packages/api/openapi/api.yaml -g go -o go-client --additional-properties=packageVersion=${TAG} --additional-properties=moduleName=github.com/lwshen/vault-hub-go-client --git-user-id lwshen --git-repo-id vault-hub-go-client
    # Initialize Go module
    - cd go-client
    - go mod tidy
    - go build ./...
